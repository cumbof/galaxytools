<?xml version="1.0"?>
<tool name="profile" id="metasbt_profile" version="@TOOL_VERSION@+galaxy@GALAXY_VERSION@" profile="@PROFILE@" license="MIT">
    <description>genomes with MetaSBT to infer their taxonomic</description>

    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="creator"/>
    <expand macro="requirements"/>

    <command detect_errors="exit_code"><![CDATA[
#set workdir="./workdir"
#set input_dir="${workdir}/genomes"

mkdir -p ${input_dir} &&

#for $genome in $genomes:
    #if $genome.ext.endswith("gz"):
        gunzip "$genome" > "${input_dir}/${genome.name}.fna" &&
    #else
        ln -s "$genome" "${input_dir}/${genome.name}.fna" &&
    #end if
#end for

find ${input_dir} -type f -name "*.fna" -exec realpath {} \; > ${input_dir}/genomes.txt &&

#set tarball_filepath = "${workdir}/${database.db_tarball.name}"

ln -s "$database.db_tarball" "$tarball_filepath" &&

metasbt unpack --workdir $workdir \
               --tarball "$tarball_filepath" &&

metasbt profile --workdir $workdir \
                --database $(basename "$tarball_filepath" | cut -d'-' -f2) \
                --genomes ${input_dir}/genomes.txt \
                --uncertainty $advanced.uncertainty \
                --pruning-threshold $advanced.pruning_threshold \
                --nproc \${GALAXY_SLOTS:-4} &&

rm "$tarball_filepath" &&

mkdir output &&

find ${workdir}/tmp/profiles -type f -name "*.txt" \
    -exec sh -c 'cp "$1" "output/$(basename "$1")"' _ {} \;
    ]]></command>

    <inputs>
        <param name="genomes" format="fa,fasta,fna,fa.gz,fasta.gz,fna.gz" multiple="true" type="data"
               label="Input genomes"
               help="Select the genomes to be profiled with MetaSBT." />

        <conditional name="database">
            <param name="source" type="select"
                   label="Database source"
                   help="Select whether to use a public MetaSBT database or one from your history.">
                <option value="cvmfs">Use a public database</option>
                <option value="history">Use a database from the history</option>
            </param>

            <when value="cvmfs">
                <param name="db_tarball" type="select"
                       label="Select a public MetaSBT database"
                       help="Choose a specific version of a public database.">
                    <options from_data_table="metasbt_databases">
                        <column name="value" index="2" />
                        <column name="name" format="${0} (v${1})" />
                        <filter type="sort_by" column="1" />
                    </options>
                    <validator type="no_options" message="There are no MetaSBT databases available." />
                </param>
            </when>

            <when value="history">
                <param name="db_tarball" type="data" format="tar.gz"
                       label="Select a MetaSBT database tarball" />
            </when>
        </conditional>

        <section name="advanced" expanded="false" title="Advanced options">
            <param name="uncertainty" type="float" value="20.0" min="0.0" max="100.0"
                   label="Uncertainty percentage"
                   help="Include all best hits within this percentage from the top hit." />

            <param name="pruning_threshold" type="float" value="0.0" min="0.0" max="1.0"
                   label="Pruning threshold"
                   help="Filter out paths in the Sequence Bloom Tree below this pruning threshold." />
        </section>
    </inputs>

    <outputs>
        <collection name="profiles" type="list" label="${tool.name} on ${on_string}: taxonomic profiles">
            <discover_datasets pattern="(?P&lt;name&gt;.+)\.txt" directory="output" ext="tabular" visible="true" />
        </collection>
    </outputs>

    <tests>
        <test>
            <!-- Add test cases here -->
        </test>
    </tests>

    <help>
<![CDATA[
**What it does**

This tool wraps the `profile` subcommand of MetaSBT to infer the closest taxonomic assignments for a set of genomes using a MetaSBT database.

**Input**  
A list of genomes in FASTA or compressed format.

**Output**  
A collection of 3-column tables (level, closest, ANI) per input genome.

Each table reports the most likely taxonomic assignments at different levels (e.g., kingdom, phylum), with their estimated Average Nucleotide Identity (ANI).

-----

.. class:: infomark

Please visit the official GitHub repository_ for additional information about MetaSBT.
Public MetaSBT Databases are available at the official MetaSBT-DBs_ repository.

.. _repository: https://github.com/cumbof/MetaSBT
.. _MetaSBT-DBs: https://github.com/cumbof/MetaSBT-DBs
]]>
    </help>

    <expand macro="citations"/>
</tool>
